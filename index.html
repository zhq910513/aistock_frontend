<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AIStock - 候选池编辑</title>
  <base href="/aistock/" />
  <style>
    :root{
      --bg:#0b1020;--panel:#111a33;--text:#e6e9f2;--muted:#a9b2c8;--line:rgba(255,255,255,0.08);
      --accent:#78a9ff;--good:#6ee7b7;--warn:#fbbf24;--bad:#fb7185;--shadow:0 10px 30px rgba(0,0,0,0.35);
      --radius:16px;--mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;font-family:var(--sans);
      background: radial-gradient(1200px 600px at 20% 10%, rgba(120,169,255,0.18), transparent 60%),
                  radial-gradient(900px 500px at 85% 20%, rgba(110,231,183,0.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .head{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 14px;border-radius:18px;
      background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, rgba(120,169,255,0.9), rgba(110,231,183,0.85));
      display:grid;place-items:center;color:#081024;font-weight:900;letter-spacing:-1px;
    }
    .title{display:grid;gap:2px}
    .title h1{margin:0;font-size:15px;line-height:1.1}
    .title p{margin:0;font-size:12px;color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);color:var(--muted);font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--muted)}
    .dot.good{background:var(--good)} .dot.bad{background:var(--bad)}
    .card{
      margin-top:14px;background:rgba(17,26,51,0.72);border:1px solid rgba(255,255,255,0.08);
      border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;
    }
    .card h2{margin:0 0 10px;font-size:13px;color:var(--muted);font-weight:600}
    .hint{color:var(--muted);font-size:12px;line-height:1.5}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .input,select{
      border-radius:14px;border:1px solid rgba(255,255,255,0.10);background:rgba(0,0,0,0.18);
      color:var(--text);padding:10px 12px;outline:none;font-family:var(--sans);width:100%;
    }
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:600}
    .mono{font-family:var(--mono)}
    .btn{
      background:rgba(120,169,255,0.12);border:1px solid rgba(120,169,255,0.25);
      color:var(--text);padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:700;font-size:12px;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .toast{
      position:fixed;right:20px;bottom:20px;width:min(420px, calc(100vw - 40px));
      background:rgba(17,26,51,0.95);border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;padding:12px 12px;box-shadow:var(--shadow);display:none;z-index:50;
    }
    .toast.show{display:block}
    .toast .t{font-weight:800;font-size:12px;margin-bottom:6px}
    .toast .m{color:var(--muted);font-size:12px;white-space:pre-wrap}
    @media (max-width: 980px){ .row{align-items:stretch} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <div class="brand">
      <div class="logo">S³</div>
      <div class="title">
        <h1>候选池编辑</h1>
        <p>只做一件事：编辑 p_limit_up（保存后即从列表消失）</p>
      </div>
    </div>
    <div class="pill" id="pill">
      <span class="dot" id="pillDot"></span>
      <span id="pillText">连接中…</span>
    </div>
  </div>

  <div class="card">
    <h2>批次</h2>
    <div class="row">
      <div style="flex:1;min-width:260px">
        <div class="hint">选择 batch（默认最新）</div>
        <select class="input" id="selBatch"></select>
      </div>
      <button class="btn" id="btnCommit">提交 commit</button>
    </div>
    <div style="height:10px"></div>
    <div class="hint">
      说明：页面只展示 <span class="mono">PENDING_EDIT</span> 候选。<br/>
      你填写并保存 <span class="mono">p_limit_up</span> 后，该条目将不再出现（已完成编辑）。
    </div>
  </div>

  <div class="card">
    <h2>待编辑候选列表</h2>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>symbol</th>
            <th>name</th>
            <th>high_days</th>
            <th>limit_up_type</th>
            <th>turnover_rate</th>
            <th>change_rate</th>
            <th>p_limit_up</th>
            <th>保存</th>
          </tr>
        </thead>
        <tbody id="tblCandidates"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <div class="t" id="toastTitle"></div>
  <div class="m" id="toastMsg"></div>
</div>

<script>
(() => {
  const API_BASE = '/aistock/api';
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  const selBatch = $('#selBatch');
  const tbl = $('#tblCandidates');
  const pillDot = $('#pillDot');
  const pillText = $('#pillText');

  function escapeHtml(s) {
    return String(s ?? '').replace(/[&<>"']/g, (m) => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function showToast(title, msg) {
    $('#toastTitle').textContent = title;
    $('#toastMsg').textContent = msg;
    const t = $('#toast');
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 4200);
  }

  function dotStatus(kind) {
    pillDot.classList.remove('good','bad');
    pillDot.classList.add(kind);
  }

  async function apiSend(method, path, body) {
    const res = await fetch(API_BASE + path, {
      method,
      headers: {'Content-Type': 'application/json'},
      body: body ? JSON.stringify(body) : undefined,
    });
    const txt = await res.text();
    let json;
    try { json = txt ? JSON.parse(txt) : null; } catch { json = null; }
    if (!res.ok) {
      const msg = (json && (json.detail || json.message)) ? (json.detail || json.message) : txt;
      throw new Error(msg || `HTTP ${res.status}`);
    }
    return json;
  }
  const apiGet = (path) => apiSend('GET', path);
  const apiPost = (path, body) => apiSend('POST', path, body);
  const apiPatch = (path, body) => apiSend('PATCH', path, body);

  async function refreshPill() {
    try {
      const s = await apiGet('/ui/health');
      pillText.textContent = `后端在线 · ${escapeHtml(s.version || 'v')}`;
      dotStatus('good');
    } catch (e) {
      pillText.textContent = '后端离线';
      dotStatus('bad');
    }
  }

  async function loadBatches() {
    const batches = await apiGet('/pool/batches?limit=50');
    const opts = (batches || []).map(b => {
      const label = `${b.trading_day || ''} · ${b.batch_id} · ${b.status || ''}`;
      return `<option value="${escapeHtml(b.batch_id)}">${escapeHtml(label)}</option>`;
    }).join('');
    selBatch.innerHTML = opts || `<option value="">暂无 batch</option>`;
    if (!selBatch.value && selBatch.options.length > 0) selBatch.value = selBatch.options[0].value;
  }

  async function loadCandidates() {
    const batchId = selBatch.value;
    if (!batchId) {
      tbl.innerHTML = `<tr><td colspan="8" class="hint">暂无 batch</td></tr>`;
      return;
    }

    // 强制只看待编辑项（已编辑的不显示）
    const cands = await apiGet(`/pool/batches/${encodeURIComponent(batchId)}/candidates?status=PENDING_EDIT&limit=5000`);
    const rows = (cands || []).map(c => {
      const raw = c.raw_json || {};
      const highDays = raw.high_days ?? '';
      const lut = raw.limit_up_type ?? '';
      const tr = raw.turnover_rate ?? '';
      const cr = raw.change_rate ?? '';
      const pl = (c.p_limit_up === null || c.p_limit_up === undefined) ? '' : String(c.p_limit_up);

      return `<tr data-symbol="${escapeHtml(c.symbol)}">
        <td class="mono">${escapeHtml(c.symbol)}</td>
        <td>${escapeHtml(c.name || '')}</td>
        <td>${escapeHtml(highDays)}</td>
        <td>${escapeHtml(lut)}</td>
        <td>${escapeHtml(tr)}</td>
        <td>${escapeHtml(cr)}</td>
        <td style="min-width:160px">
          <input class="input mono" style="padding:8px 10px" data-pl value="${escapeHtml(pl)}" placeholder="0~1" />
        </td>
        <td style="min-width:100px">
          <button class="btn" data-save>保存</button>
        </td>
      </tr>`;
    }).join('');

    tbl.innerHTML = rows || `<tr><td colspan="8" class="hint">没有待编辑候选（可能都已填完 p_limit_up）</td></tr>`;

    // bind save
    $$('#tblCandidates [data-save]').forEach(btn => {
      btn.onclick = async () => {
        const tr = btn.closest('tr');
        const symbol = tr.getAttribute('data-symbol');
        const input = tr.querySelector('[data-pl]');
        const v = (input.value || '').trim();

        if (v === '') {
          showToast('未填写', 'p_limit_up 必须填写后再保存（保存代表完成编辑）。');
          return;
        }
        const n = Number(v);
        if (!Number.isFinite(n) || n < 0 || n > 1) {
          showToast('格式错误', 'p_limit_up 必须是 0~1 的小数');
          return;
        }

        try {
          btn.disabled = true;
          await apiPatch(`/pool/batches/${encodeURIComponent(batchId)}/candidates/${encodeURIComponent(symbol)}`, { p_limit_up: n });
          showToast('已保存', `${symbol} p_limit_up=${n}`);
          await loadCandidates(); // 重新加载 -> 该条会消失
        } catch (e) {
          showToast('保存失败', String(e));
        } finally {
          btn.disabled = false;
        }
      };
    });
  }

  async function init() {
    await refreshPill();
    await loadBatches();
    await loadCandidates();

    // batch 切换自动刷新列表
    selBatch.onchange = loadCandidates;

    // commit
    $('#btnCommit').onclick = async () => {
      const batchId = selBatch.value;
      if (!batchId) return;
      try {
        const btn = $('#btnCommit');
        btn.disabled = true;
        await apiPost(`/pool/batches/${encodeURIComponent(batchId)}/commit`, {});
        showToast('已提交', `batch=${batchId} 已 COMMITTED`);
      } catch (e) {
        showToast('提交失败', String(e));
      } finally {
        $('#btnCommit').disabled = false;
      }
    };

    // 只做“自动”刷新后端连通性提示，不提供任何手动刷新按钮
    setInterval(refreshPill, 15000);
  }

  init().catch(e => showToast('初始化失败', String(e)));
})();
</script>
</body>
</html>
